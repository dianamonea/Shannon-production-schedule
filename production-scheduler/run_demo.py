#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å®Œæ•´çš„ç”Ÿäº§è°ƒåº¦æ¼”ç¤º - 6ä¸ªAgentå±•ç¤º
ç­‰å¾…DockeræœåŠ¡å¯åŠ¨åç«‹å³è¿è¡Œæ­¤è„šæœ¬
"""

import requests
import time
import json
from datetime import datetime

def check_api_ready(api_url="http://localhost:8080", max_retries=60):
    """æ£€æŸ¥APIæ˜¯å¦å°±ç»ª"""
    for attempt in range(max_retries):
        try:
            response = requests.get(f"{api_url}/health", timeout=5)
            if response.status_code == 200:
                print(f"âœ… APIå·²å°±ç»ª (å°è¯• {attempt+1}/{max_retries})")
                return True
        except:
            pass
        
        if attempt < max_retries - 1:
            print(f"â³ ç­‰å¾…APIå¯åŠ¨... ({attempt+1}/{max_retries})")
            time.sleep(1)
    
    return False

def run_production_scheduling_demo():
    """è¿è¡Œå®Œæ•´çš„ç”Ÿäº§è°ƒåº¦æ¼”ç¤º"""
    api_url = "http://localhost:8080"
    
    print("\n" + "="*80)
    print("ğŸ¯ Shannon ç”Ÿäº§è°ƒåº¦ç³»ç»Ÿ - å®Œæ•´6 Agentæ¼”ç¤º")
    print("="*80 + "\n")
    
    # æ£€æŸ¥APIå°±ç»ª
    print("ğŸ“‹ ç¬¬1æ­¥ï¼šæ£€æŸ¥APIæœåŠ¡...")
    if not check_api_ready(api_url):
        print("âŒ APIæœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥Dockerå®¹å™¨")
        return
    
    # åˆ›å»ºæ¼”ç¤ºä»»åŠ¡
    print("\nğŸ“‹ ç¬¬2æ­¥ï¼šåˆ›å»ºç”Ÿäº§è°ƒåº¦æ¼”ç¤ºä»»åŠ¡...\n")
    
    demo_query = """
ä½œä¸ºç”Ÿäº§è¿è¥æ€»ç›‘ï¼Œè¯·å®Œæ•´åˆ†æå’Œè§„åˆ’ä»¥ä¸‹ç”Ÿäº§è°ƒåº¦åœºæ™¯ï¼š

ã€è®¢å•ä¿¡æ¯ã€‘
- è®¢å•Aï¼š200ä»¶é«˜ç²¾å¯†éƒ¨ä»¶ï¼Œå®¢æˆ·Aï¼Œäº¤æœŸ 3å¤©ï¼ˆç´§æ€¥ï¼‰
- è®¢å•Bï¼š500ä»¶æ ‡å‡†ä»¶ï¼Œå®¢æˆ·Bï¼Œäº¤æœŸ 7å¤©ï¼ˆæ™®é€šï¼‰
- è®¢å•Cï¼š300ä»¶é…ä»¶ï¼Œå®¢æˆ·Cï¼Œäº¤æœŸ 14å¤©ï¼ˆéç´§æ€¥ï¼‰

ã€ç”Ÿäº§è®¾å¤‡çŠ¶æ€ã€‘
- ç²¾å¯†åŠ å·¥çº¿ï¼šåœ¨çº¿ï¼Œæ•ˆç‡100%ï¼Œäº§èƒ½200ä»¶/å¤©
- æ ‡å‡†ç”Ÿäº§çº¿ï¼šåœ¨çº¿ï¼Œæ•ˆç‡85%ï¼Œäº§èƒ½400ä»¶/å¤©  
- è£…é…çº¿1ï¼šåœ¨çº¿ï¼Œæ•ˆç‡90%ï¼Œäº§èƒ½500ä»¶/å¤©
- è£…é…çº¿2ï¼šç»´ä¿ä¸­ï¼Œé¢„è®¡3å¤©åæ¢å¤

ã€åŸææ–™åº“å­˜ã€‘
- Aç±»é’¢æï¼šåº“å­˜500ä»¶ï¼Œæˆæœ¬Â¥2/ä»¶
- Bç±»é“åˆé‡‘ï¼šåº“å­˜200ä»¶ï¼Œæˆæœ¬Â¥5/ä»¶
- Cç±»é…ä»¶ï¼šåº“å­˜100ä»¶ï¼Œæˆæœ¬Â¥10/ä»¶
- Dç±»ç”µå­å…ƒå™¨ä»¶ï¼šåº“å­˜50ä»¶ï¼Œæˆæœ¬Â¥20/ä»¶

ã€å…¶ä»–çº¦æŸã€‘
- å‘˜å·¥ç­åˆ¶ï¼šä¸‰ç­åˆ¶ï¼ˆæ¯ç­8å°æ—¶ï¼‰
- è´¨æ£€æ ‡å‡†ï¼š100%å…¨æ£€ï¼Œå…è®¸ç¼ºé™·ç‡<0.5%
- è¿è¾“æ—¶é—´ï¼š2å¤©
- é¢„è®¡æˆæœ¬é¢„ç®—ï¼šÂ¥50,000

ã€è¦æ±‚åˆ†æã€‘
è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œå®Œæ•´åˆ†æï¼š

1ï¸âƒ£ è®¢å•åˆ†æå¸ˆï¼šåˆ†æè®¢å•ç‰¹å¾ï¼Œæ’åˆ—ä¼˜å…ˆçº§ï¼Œè¯„ä¼°éš¾åº¦
2ï¸âƒ£ è®¾å¤‡è§„åˆ’å¸ˆï¼šåˆ¶å®šè®¾å¤‡åˆ†é…æ–¹æ¡ˆï¼Œä¼˜åŒ–äº§çº¿å®‰æ’  
3ï¸âƒ£ ç‰©æµåè°ƒå‘˜ï¼šæ£€æŸ¥åº“å­˜å……è¶³æ€§ï¼Œè®¡ç®—æ‰€éœ€åŸææ–™ï¼Œè¯„ä¼°æ˜¯å¦éœ€è¦é‡‡è´­
4ï¸âƒ£ è´¨é‡æ£€æŸ¥å‘˜ï¼šåˆ¶å®šè´¨é‡æ§åˆ¶è®¡åˆ’ï¼Œç¡®ä¿äº¤ä»˜å“è´¨
5ï¸âƒ£ æˆæœ¬åˆ†æå¸ˆï¼šè®¡ç®—æˆæœ¬é¢„ä¼°ï¼Œè¯„ä¼°åˆ©æ¶¦ç‡ï¼Œæå‡ºæˆæœ¬ä¼˜åŒ–å»ºè®®
6ï¸âƒ£ æ€»è°ƒåº¦å¸ˆï¼šç»¼åˆå‰5ä¸ªAgentçš„åˆ†æï¼Œç”Ÿæˆæœ€ç»ˆå®Œæ•´çš„ç”Ÿäº§è°ƒåº¦æ–¹æ¡ˆ

è¾“å‡ºæœ€ç»ˆçš„å®Œæ•´ç”Ÿäº§è®¡åˆ’è¡¨ã€‚
"""
    
    try:
        session_id = f"production-demo-{int(time.time())}"
        
        response = requests.post(
            f"{api_url}/api/v1/tasks",
            headers={"Content-Type": "application/json"},
            json={
                "query": demo_query,
                "session_id": session_id
            },
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            task_id = data.get("task_id")
            
            print(f"âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼\n")
            print(f"ğŸ“Œ Session ID: {session_id}")
            print(f"ğŸ“‹ Task ID: {task_id}\n")
            
            print("="*80)
            print("ğŸŒ å¯è§†åŒ–è®¿é—®æ–¹å¼ï¼š")
            print("="*80 + "\n")
            
            print("ã€æ–¹å¼1ã€‘Temporal UI (æ¨èç”¨äºæŸ¥çœ‹å·¥ä½œæµæ‰§è¡Œç»†èŠ‚)")
            print(f"  ğŸ”— http://localhost:8088")
            print(f"  æœç´¢ Workflow ID: {task_id}\n")
            
            print("ã€æ–¹å¼2ã€‘Shannon Web UI (æ¨èç”¨äºå®æ—¶ä»»åŠ¡ç›‘æ§)")
            print(f"  ğŸ”— http://localhost:3000")
            print(f"  æŸ¥æ‰¾ Session: {session_id}\n")
            
            print("="*80)
            print("ğŸ“Š æ¼”ç¤ºå†…å®¹è¯´æ˜ï¼š")
            print("="*80 + "\n")
            
            print("æ­¤æ¼”ç¤ºåŒ…å«ä»¥ä¸‹6ä¸ªAI Agentçš„ååŒå·¥ä½œï¼š\n")
            print("1. ğŸ¤– è®¢å•åˆ†æå¸ˆ")
            print("   - åˆ†æ3ä¸ªè®¢å•çš„ç‰¹å¾")
            print("   - æ’åˆ—ä¼˜å…ˆçº§é¡ºåº")
            print("   - è¯„ä¼°ç”Ÿäº§éš¾åº¦\n")
            
            print("2. ğŸ¤– è®¾å¤‡è§„åˆ’å¸ˆ")
            print("   - åˆ¶å®š4æ¡äº§çº¿çš„åˆ†é…æ–¹æ¡ˆ")
            print("   - è®¡ç®—äº§èƒ½å’Œæ—¶é—´å®‰æ’")
            print("   - ä¼˜åŒ–ç”Ÿäº§æµç¨‹\n")
            
            print("3. ğŸ¤– ç‰©æµåè°ƒå‘˜")
            print("   - æ£€æŸ¥4ç§åŸææ–™åº“å­˜")
            print("   - è®¡ç®—ç”Ÿäº§æ‰€éœ€ææ–™")
            print("   - è¯„ä¼°é‡‡è´­éœ€æ±‚\n")
            
            print("4. ğŸ¤– è´¨é‡æ£€æŸ¥å‘˜")
            print("   - åˆ¶å®šå®Œæ•´è´¨æ§è®¡åˆ’")
            print("   - ç¡®å®šæ£€æŸ¥é¢‘ç‡å’Œæ ‡å‡†")
            print("   - è®¡åˆ’æ•´æ”¹æªæ–½\n")
            
            print("5. ğŸ¤– æˆæœ¬åˆ†æå¸ˆ")
            print("   - è®¡ç®—æ€»æˆæœ¬")
            print("   - è¯„ä¼°åˆ©æ¶¦ç©ºé—´")
            print("   - æå‡ºä¼˜åŒ–å»ºè®®\n")
            
            print("6. ğŸ¤– æ€»è°ƒåº¦å¸ˆ")
            print("   - ç»¼åˆæ‰€æœ‰åˆ†æç»“æœ")
            print("   - ç”Ÿæˆæœ€ç»ˆè°ƒåº¦æ–¹æ¡ˆ")
            print("   - è¾“å‡ºå®Œæ•´çš„ç”˜ç‰¹å›¾\n")
            
            print("="*80)
            print("ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š")
            print("="*80 + "\n")
            
            print("âœ… æ‰“å¼€Temporal UI (http://localhost:8088)")
            print("âœ… æˆ–æ‰“å¼€Shannon Web UI (http://localhost:3000)")
            print("âœ… æœç´¢/æŸ¥æ‰¾ä¸Šè¿° Session ID æˆ– Task ID")
            print("âœ… å®æ—¶è§‚çœ‹æ‰€æœ‰Agentçš„æ‰§è¡Œè¿‡ç¨‹ï¼\n")
            
            print("â³ ä»»åŠ¡é¢„è®¡æ‰§è¡Œæ—¶é—´ï¼š2-5åˆ†é’Ÿ")
            print("ğŸ“ˆ å¯ä»¥åœ¨Grafana (http://localhost:3030) æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ\n")
            
            return session_id, task_id
            
        else:
            print(f"âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥: HTTP {response.status_code}")
            print(f"å“åº”: {response.text}")
            return None, None
            
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        return None, None

if __name__ == "__main__":
    session_id, task_id = run_production_scheduling_demo()
    
    if session_id and task_id:
        print("\nâœ¨ æ¼”ç¤ºå·²å¯åŠ¨ï¼ç°åœ¨å¯ä»¥åœ¨Web UIä¸­æŸ¥çœ‹å®æ—¶è¿›åº¦ã€‚\n")
